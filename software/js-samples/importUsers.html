<!DOCTYPE html><html lang=en><head><meta charset=utf-8><title>Geotab SDK | Import Users Example - ENHANCED</title><link rel=icon href=./images/favicon.ico><link href=css/JavaScriptExamples.css rel=stylesheet type=text/css><link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel=stylesheet><link href=https://cdnjs.cloudflare.com/ajax/libs/chosen/1.1.0/chosen.min.css rel=stylesheet type=text/css><style>/* Enhanced Progress Container Styles */
            .progress-container {
                display: none;
                margin: 20px 0;
                padding: 20px;
                background: #f5f5f5;
                border-radius: 8px;
            }

            .progress-bar-container {
                width: 100%;
                height: 30px;
                background-color: #e0e0e0;
                border-radius: 15px;
                overflow: hidden;
                margin-bottom: 20px;
            }

            .progress-bar-fill {
                height: 100%;
                background: linear-gradient(90deg, #2196F3 0%, #1976D2 100%);
                color: white;
                text-align: center;
                line-height: 30px;
                font-weight: bold;
                transition: width 0.3s ease;
                width: 0;
            }

            .progress-stats {
                display: flex;
                justify-content: space-around;
                gap: 15px;
                flex-wrap: wrap;
            }

            .stat-card {
                flex: 1;
                min-width: 120px;
                background: white;
                padding: 15px;
                border-radius: 8px;
                text-align: center;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }

            .stat-value {
                font-size: 32px;
                font-weight: bold;
                color: #333;
                margin-bottom: 5px;
                display: flex;
                align-items: center;
                justify-content: center;
                background: transparent;
            }

            .stat-label {
                font-size: 14px;
                color: #666;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }

            /* Results Section Styles */
            .results-section {
                display: none;
                margin: 20px 0;
            }

            .results-section h3 {
                margin-bottom: 15px;
                color: #333;
            }

            .results-table {
                width: 100%;
                border-collapse: collapse;
                background: white;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }

            .results-table thead {
                background: #2c3e50;
                color: white;
            }

            .results-table th,
            .results-table td {
                padding: 12px;
                text-align: left;
                border-bottom: 1px solid #ddd;
            }

            .results-table tbody tr:hover {
                background-color: #f5f5f5;
            }

            .status-success {
                color: #4CAF50;
                font-weight: bold;
            }

            .status-failure {
                color: #f44336;
                font-weight: bold;
            }</style></head><body><header><nav><a href=https://developers.geotab.com/myGeotab/introduction/ target=_blank><img src=./images/pillar.svg width=35 height=35 alt=""><h1>MyGeotab SDK</h1></a><div class=sample-tooltip><h1>DEVELOPER SAMPLE</h1><div class=sample-tooltip-text><p>This tool is provided as an example and is available on an As-Is basis. You must assume all the risks and costs associated with the use of the sample tool, including, without limitation, any damage to any equipment, software, information or data. In addition, we are not obligated to provide any maintenance, technical or other support for the sample tool. In order to improve our products, we may at any time, and without warning, change the design, presentation, or functionality of the software.</p></div></div><button class="primary-btn sign-out-btn" id=signout>Sign out</button> <button class="secondary-btn template-btn" id=template>Template</button></nav></header><div class=container><div id=signin-content></div><div class=example-header><div class=title>Import Users Example</div><div class=skill-level>Skill level:<div class=skill-tooltip><img src=images/advanced-pill.svg><div class=skill-text><p>This example demonstrates a tool that can be built with an advanced-level knowledge of the MyGeotab system. It is suitable for those who have a well-versed understanding of the entire Geotab ecosystem and are confident with the MyGeotab SDK and leveraging the MyGeotab APIs within their projects.</p></div></div></div><div class=description>This SDK example assists with importing users to your database using comma separated values (CSV). Use the form to add new users with optional NFC or GO driver keys. You can also use the text box to paste in users from another source. You can also control whether to delay sending the verification email to users.</div><div class=api-references>In this example<details open><summary>API Methods:</summary><a href=https://developers.geotab.com/myGeotab/apiReference/methods/Add/ target=_blank>Add</a></details><details open><summary>API Entities:</summary><a href=https://developers.geotab.com/myGeotab/apiReference/objects/Driver/ target=_blank>Driver</a> <a href=https://developers.geotab.com/myGeotab/apiReference/objects/HosRuleSet/ target=_blank>HosRuleSet</a></details></div></div><div id=example-content><form><p><label for=import-userName>Email or Username</label> <input id=import-userName type=text placeholder=user@geotab.com maxlength=255></p><p><label for=import-firstName>Full Name</label> <input id=import-firstName type=text placeholder=John maxlength=255> <input id=import-lastName type=text placeholder=Smith maxlength=255></p><p><label for=import-password>Password</label> <input id=import-password type=password placeholder="Minimum of 8 characters" maxlength=255> <label style="font-size: 14px; margin-top: 10px;"><input id=import-password-reset style=float:none type=checkbox title="This user will need to enter a new password the first time they log in to the database.">Force password change on next login</label></p><p><label for=import-groups>Groups</label> <select id=import-groups multiple=multiple data-placeholder="Select groups"></select></p><p><label for=import-reporting-groups>Reporting Groups</label> <select id=import-reporting-groups multiple=multiple data-placeholder="Select reporting groups"></select></p><p><label for=import-securityClearance>Security Clearance</label> <select id=import-securityClearance></select></p><p><label for=import-nfcKey>Driver Key (optional)</label> <input id=import-nfcKey type=text placeholder="NFC key number"> <input id=import-customNFC type=text placeholder="Custom NFC key number"></p><p><label for=import-countryCode>Country Code / Phone Number / Ext (optional)</label> <select name=country id=import-countryCode><option value=CA>Canada +1</option><option value=US>United States +1</option><option value=AL>Albania +355</option><option value=AD>Andorra +376</option><option value=AO>Angola +244</option><option value=AR>Argentina +54</option><option value=AM>Armenia +374</option><option value=AU>Australia +61</option><option value=AT>Austria +43</option><option value=AZ>Azerbaijan +994</option><option value=BS>Bahamas +1-242</option><option value=BH>Bahrain +973</option><option value=BD>Bangladesh +880</option><option value=BY>Belarus +375</option><option value=BE>Belgium +32</option><option value=BZ>Belize +501</option><option value=BT>Bhutan +975</option><option value=BO>Bolivia +591</option><option value=BA>Bosnia and Herzegovina +387</option><option value=BW>Botswana +267</option><option value=BR>Brazil +55</option><option value=BG>Bulgaria +359</option><option value=BF>Burkina Faso +226</option><option value=KH>Cambodia +855</option><option value=CM>Cameroon +237</option><option value=CF>Central African Republic +236</option><option value=TD>Chad +235</option><option value=CL>Chile +56</option><option value=CN>China +86</option><option value=CO>Colombia +57</option><option value=CR>Costa Rica +506</option><option value=HR>Croatia +385</option><option value=CU>Cuba +53</option><option value=CY>Cyprus +357</option><option value=CZ>Czech Republic +420</option><option value=CD>Democratic Republic of the Congo +243</option><option value=DK>Denmark +45</option><option value=DO>Dominican Republic +1</option><option value=EC>Ecuador +593</option><option value=EG>Egypt +20</option><option value=SV>El Salvador +503</option><option value=EE>Estonia +372</option><option value=ET>Ethiopia +251</option><option value=FI>Finland +358</option><option value=FR>France +33</option><option value=GA>Gabon +241</option><option value=GE>Georgia +995</option><option value=DE>Germany +49</option><option value=GH>Ghana +233</option><option value=GR>Greece +30</option><option value=GT>Guatemala +502</option><option value=GN>Guinea +224</option><option value=GW>Guinea-Bissau +245</option><option value=GY>Guyana +592</option><option value=HN>Honduras +504</option><option value=HK>Hong Kong +852</option><option value=HU>Hungary +36</option><option value=IS>Iceland +354</option><option value=IN>India +91</option><option value=ID>Indonesia +62</option><option value=IE>Ireland +353</option><option value=IL>Israel +972</option><option value=IT>Italy +39</option><option value=CI>Ivory Coast +225</option><option value=JM>Jamaica +1</option><option value=JP>Japan +81</option><option value=JO>Jordan +962</option><option value=KZ>Kazakhstan +7</option><option value=KE>Kenya +254</option><option value=XK>Kosovo +383</option><option value=LA>Laos +856</option><option value=LV>Latvia +371</option><option value=LB>Lebanon +961</option><option value=LS>Lesotho +266</option><option value=LR>Liberia +231</option><option value=LY>Libya +218</option><option value=LI>Liechtenstein +423</option><option value=LT>Lithuania +370</option><option value=LU>Luxembourg +352</option><option value=MK>Macedonia +389</option><option value=MG>Madagascar +261</option><option value=MW>Malawi +265</option><option value=MY>Malaysia +60</option><option value=ML>Mali +223</option><option value=MT>Malta +356</option><option value=MR>Mauritania +222</option><option value=MX>Mexico +52</option><option value=MD>Moldova +373</option><option value=MC>Monaco +377</option><option value=MN>Mongolia +976</option><option value=ME>Montenegro +382</option><option value=MA>Morocco +212</option><option value=MZ>Mozambique +258</option><option value=MM>Myanmar +95</option><option value=NA>Namibia +264</option><option value=NP>Nepal +977</option><option value=NL>Netherlands +31</option><option value=NZ>New Zealand +64</option><option value=NI>Nicaragua +505</option><option value=NE>Niger +227</option><option value=NG>Nigeria +234</option><option value=NO>Norway +47</option><option value=OM>Oman +968</option><option value=PA>Panama +507</option><option value=PG>Papua New Guinea +675</option><option value=PY>Paraguay +595</option><option value=PE>Peru +51</option><option value=PH>Philippines +63</option><option value=PL>Poland +48</option><option value=PT>Portugal +351</option><option value=PR>Puerto Rico +1</option><option value=QA>Qatar +947</option><option value=CG>Republic of the Congo +242</option><option value=RO>Romania +40</option><option value=RU>Russia +7</option><option value=RW>Rwanda +250</option><option value=SM>San Marino +378</option><option value=SA>Saudi Arabia +966</option><option value=SN>Senegal +221</option><option value=RS>Serbia +381</option><option value=SL>Sierra Leone +232</option><option value=SG>Singapore +65</option><option value=SK>Slovakia +421</option><option value=SI>Slovenia +386</option><option value=ZA>South Africa +27</option><option value=KR>South Korea +82</option><option value=SS>South Sudan +211</option><option value=ES>Spain +34</option><option value=LK>Sri Lanka +94</option><option value=SD>Sudan +249</option><option value=SR>Suriname +597</option><option value=SZ>Swaziland +268</option><option value=SE>Sweden +46</option><option value=CH>Switzerland +41</option><option value=TW>Taiwan +886</option><option value=TJ>Tajikistan +992</option><option value=TZ>Tanzania +255</option><option value=TH>Thailand +66</option><option value=TN>Tunisia +216</option><option value=TR>Turkey +90</option><option value=TM>Turkmenistan +993</option><option value=UG>Uganda +256</option><option value=UA>Ukraine +380</option><option value=AE>United Arab Emirates +971</option><option value=GB>United Kingdom +44</option><option value=UY>Uruguay +598</option><option value=UZ>Uzbekistan +998</option><option value=VE>Venezuela +58</option><option value=VN>Vietnam +84</option><option value=ZM>Zambia +260</option><option value=ZW>Zimbabwe +263</option><option value="">Other</option></select> <input id=import-phoneNumber type=text placeholder="+1 5555555555" maxlength=20> <input id=import-phoneNumberExtension type=text placeholder=1234 maxlength=5></p><p><label for=import-designation>Designation (optional)</label> <input id=import-designation type=text maxlength=50></p><p><label for=import-employeeNumber>Employee Number (optional)</label> <input id=import-employeeNumber type=text maxlength=255></p><p></p><div class=checkmateField><label class=label>Fuel Economy Measurement:</label><div id=options_fuelEconomySelect><input type=radio name=fuelButton value=LitersPer100Km id=Lper100km checked=checked> <label>L/100 km</label><input type=radio name=fuelButton value=KmPerLiter id=kmperL> <label>km/L</label><input type=radio name=fuelButton value=MPGUS id=mpgUS> <label>MPG (US)</label><input type=radio name=fuelButton value=MPGImperial id=mpgImp> <label>MPG (Imp)</label></div></div><p></p><p></p><div class=checkmateField><label class=label>Distance Measurement System:</label><div id=options_measurementSelect><input type=radio name=distanceunits value=Metric id=metricUnit checked=checked> <label>Metric</label> <input type=radio name=distanceunits value=US id=usUnit> <label>US/Imperial</label></div></div><p></p><p></p><div class=checkmateField><label class=label>Feature Preview:</label><div><input type=radio name=featurePreviewRadioButton value=On id=idFeaturePreviewOn> <label>On</label> <input type=radio name=featurePreviewRadioButton value=Off id=idFeaturePreviewOff checked=checked> <label>Off</label></div></div><p></p><p><label for=options_userTimeZoneOffset>Time Zone:</label> <select id=options_userTimeZoneOffset></select></p><p></p><div class=checkmateField><label class=label>Delay Verification Email: <span style="background-color: #ffeb3b; color: #000; padding: 2px 6px; border-radius: 3px; font-size: 11px; font-weight: bold; margin-left: 5px;">NEW</span></label><div><input type=radio name=delayVerificationEmailRadioButton value=On id=idDelayVerificationEmailOn> <label>On</label> <input type=radio name=delayVerificationEmailRadioButton value=Off id=idDelayVerificationEmailOff checked=checked> <label>Off</label></div></div><p></p><button type=button class="clickable-heading secondary-btn">Click me to toggle HOS fields:</button><ul style=display:none><p></p><div class=checkmateField><label for=options_AuthorityName>Authority Name:</label> <input id=options_AuthorityName class=checkmateFormEditField title="The motor carrier that the driver works for."></div><p></p><p></p><div class=checkmateField><label for=options_AuthorityAddress>Authority Address:</label> <input id=options_AuthorityAddress class=checkmateFormEditField title="The motor carrier's main office address."></div><p></p><p></p><div class=checkmateField><label for=options_CarrierNumber>Carrier Number:</label> <input id=options_CarrierNumber class=checkmateFormEditField title="In the United States, this is the motor carrier's USDOT number. In Canada, this is the Canadian Carrier code."></div><p></p><p></p><div class=checkmateField><label for=options_Name>Home Terminal:</label> <input id=options_Name class=checkmateFormEditField title="The motor carrier's place of business where the driver ordinarily reports for work. This can include a temporary work site designated by the motor carrier."></div><p></p><p></p><div class=checkmateField><label for=options_Address>Home Terminal Address:</label> <input id=options_Address class=checkmateFormEditField title="The motor carrier's address where the driver ordinarily reports for work."></div><p></p><p></p><div class=checkmateField><label for=options_LicenseNumber>Driver License Number:</label> <input id=options_LicenseNumber class=checkmateFormEditField maxlength=1000 title="Driver's license number and License state/province must be set at the same time."></div><p></p><p></p><div class=checkmateField><label class=label>License State/Province:</label><div class="flexible set-2x buttonSet horizontalButtonSet adjustableButtonSet" id=options_licenseStateSelect title="Selecting North America will show a dropdown menu; selecting Other will display a text box."><input type=radio onclick=yesnoCheck(); name=licenseStateRadioButton value="North America" id=idLicenseStateNA><label class="geotabButton switcherItem_Metric" for=idLicenseStateNA>North America</label><input type=radio onclick=yesnoCheck(); name=licenseStateRadioButton value=Other id=idLicenseStateOther><label class="geotabButton switcherItem_US" for=idLicenseStateOther>Other</label></div></div><p></p><p></p><div id=ifYes style=display:none><div class=regionInputContainer><input type=text class="checkmateFormEditField regionInput otherRegionInput" style="display: none;"> <select id=options_licenseProvince class=checkmateFormEditField><option value=AG>Aguascalientes</option><option value=AL>Alabama</option><option value=AK>Alaska</option><option value=AB>Alberta</option><option value=AS>American Samoa</option><option value=AZ>Arizona</option><option value=AR>Arkansas</option><option value=BN>Baja California Norte</option><option value=BS>Baja California Sur</option><option value=BC>British Columbia</option><option value=CA>California</option><option value=CP>Campeche</option><option value=CS>Chiapas</option><option value=CI>Chihuahua</option><option value=CH>Coahuila</option><option value=CL>Colima</option><option value=CO>Colorado</option><option value=CT>Connecticut</option><option value=DE>Delaware</option><option value=DC>Dist of col</option><option value=DF>Districto Federal</option><option value=DG>Durango</option><option value=FL>Florida</option><option value=GA>Georgia</option><option value=GU>Guam</option><option value=GJ>Guanajuato</option><option value=GE>Guerrero</option><option value=HI>Hawaii</option><option value=HD>Hidalgo</option><option value=ID>Idaho</option><option value=IL>Illinois</option><option value=IN>Indiana</option><option value=IA>Iowa</option><option value=JA>Jalisco</option><option value=KS>Kansas</option><option value=KY>Kentucky</option><option value=LA>Louisiana</option><option value=ME>Maine</option><option value=MB>Manitoba</option><option value=MD>Maryland</option><option value=MA>Massachusetts</option><option value=MX>Mexico</option><option value=MI>Michigan</option><option value=MC>Michoacan</option><option value=MN>Minnesota</option><option value=MS>Mississippi</option><option value=MO>Missouri</option><option value=MT>Montana</option><option value=MR>Morelos</option><option value=NA>Nayarit</option><option value=NE>Nebraska</option><option value=NV>Nevada</option><option value=NB>New Brunswick</option><option value=NH>New Hampshire</option><option value=NJ>New Jersey</option><option value=NM>New Mexico</option><option value=NY>New York</option><option value=NF>Newfoundland</option><option value=NC>North Carolina</option><option value=ND>North Dakota</option><option value=MP>Northern Marianas</option><option value=NT>Northwest Territories</option><option value=NS>Nova Scotia</option><option value=NL>Nuevo Leon</option><option value=OA>Oaxaca</option><option value=OH>Ohio</option><option value=OK>Oklahoma</option><option value=ON>Ontario</option><option value=OR>Oregon</option><option value=PA>Pennsylvania</option><option value=PE>Prince Edward Island</option><option value=PU>Puebla</option><option value=PR>Puerto Rico</option><option value=QC>Quebec</option><option value=QE>Queretaro</option><option value=QI>Quintana Roo</option><option value=RI>Rhode Island</option><option value=SL>San Luis Potosi</option><option value=SK>Saskatchewan</option><option value=SI>Sinaloa</option><option value=SO>Sonora</option><option value=SC>South Carolina</option><option value=SD>South Dakota</option><option value=TB>Tabasco</option><option value=TA>Tamaulipas</option><option value=TN>Tennessee</option><option value=TX>Texas</option><option value=TL>Tlaxcala</option><option value=UT>Utah</option><option value=VC>Veracruz</option><option value=VT>Vermont</option><option value=VI>Virgin Islands</option><option value=VA>Virginia</option><option value=WA>Washington</option><option value=WV>West Virginia</option><option value=WI>Wisconsin</option><option value=WY>Wyoming</option><option value=YU>Yucatan</option><option value=YT>Yukon Territory</option><option value=ZA>Zacatecas</option></select></div></div><p></p><p></p><div id=ifNo style=display:none><div class=checkmateField><input id=options_LicenseStateOther class=checkmateFormEditField maxlength=1000></div></div><p></p><p></p><div class=checkmateField><label for=options_hosRuleSet>Ruleset:</label> <select id=options_hosRuleSet class=checkmateFormEditField title="This is the ruleset the user will follow when using hours of service."><option value="">Please Select a Ruleset</option><option value=HosRuleSetAlaskaPassenger7Day>Alaska Passenger 70-hour/7-day</option><option value=HosRuleSetAlaskaPassenger8Day>Alaska Passenger 80-hour/8-day</option><option value=HosRuleSetAlaskaProperty7Day>Alaska Property 70-hour/7-day</option><option value=HosRuleSetAlaskaProperty8Day>Alaska Property 80-hour/8-day</option><option value=HosRuleSetAmerica7Day>USA Property 60-hour/7-day</option><option value=HosRuleSetAmerica7DayBig>USA Property 60-hour/7-day (16-hour exemption)</option><option value=HosRuleSetAmerica7DayNo34h>USA Property 60-hour/7-day without 34-hour restart</option><option value=HosRuleSetAmerica7DayPassenger>USA Passenger 60-hour/7-day</option><option value=HosRuleSetAmerica8Day>USA Property 70-hour/8-day</option><option value=HosRuleSetAmerica8DayBig>USA Property 70-hour/8-day (16-hour exemption)</option><option value=HosRuleSetAmerica8DayNo34h>USA Property 70-hour/8-day without 34-hour restart</option><option value=HosRuleSetAmerica8DayPassenger>USA Passenger 70-hour/8-day</option><option value=HosRuleSetAmericaNoRestRequirement7Day>USA Property 60-hour/7-day without rest requirement</option><option value=HosRuleSetAmericaNoRestRequirement7DayBig>USA Property 60-hour/7-day (16-hour exemption) without rest requirement</option><option value=HosRuleSetAmericaNoRestRequirement8Day>USA Property 70-hour/8-day without rest requirement</option><option value=HosRuleSetAmericaNoRestRequirement8DayBig>USA Property 70-hour/8-day (16-hour exemption) without rest requirement</option><option value=HosRuleSetAmericaNonCdlShortHaul7Day>Non-CDL Short-haul 60-hour/7-day</option><option value=HosRuleSetAmericaNonCdlShortHaul8Day>Non-CDL Short-haul 70-hour/8-day</option><option value=HosRuleSetAmericaSalesperson>USA Salesperson</option><option value=HosRuleSetAmericaShortHaul>USA Property Short-haul 60-hour/7-day 12hr Workday</option><option value=HosRuleSetAmericaShortHaul8Day>USA Property Short-haul 70-hour/8-day 12hr Workday</option><option value=HosRuleSetAmericaShortHaul8DayNo34h>USA Property Short-haul 70-hour/8-day without 34-hour restart</option><option value=HosRuleSetAmericaShortHaulNo34h>USA Property Short-haul 60-hour/7-day without 34-hour restart</option><option value=HosRuleSetAmericaShortHaulPassenger>USA Passenger Short-haul 60-hour/7-day</option><option value=HosRuleSetAmericaShortHaulPassenger8Day>USA Passenger Short-haul 70-hour/8-day</option><option value=HosRuleSetAmericaTexas>Texas Intrastate</option><option value=HosRuleSetAmericaTexasShortHaul>Texas Short-haul 60-hour/7-day Intrastate</option><option value=HosRuleSetAmericaTexasShortHaul8Day>Texas Short-haul 70-hour/8-day Intrastate</option><option value=HosRuleSetBrazilShortHaul>Brazil Property Short-haul</option><option value=HosRuleSetCalifornia8day>California Property Intrastate with rest requirement</option><option value=HosRuleSetCaliforniaFarmProduct>California Farm Product</option><option value=HosRuleSetCaliforniaFlammableLiquid>California Flammable Liquid</option><option value=HosRuleSetCaliforniaPassenger>California Passenger Intrastate</option><option value=HosRuleSetCaliforniaProperty>California Property Intrastate</option><option value=HosRuleSetCaliforniaSchoolPupil>California School Pupil</option><option value=HosRuleSetCanadaCycleOne>Canada 7-Day Cycle 1</option><option value=HosRuleSetCanadaCycleTwo>Canada 14-Day Cycle 2</option><option value=HosRuleSetCarrierExemption>Carrier Exemption</option><option value=HosRuleSetFlorida7Day>USA Florida 70-hour/7-Day</option><option value=HosRuleSetFlorida8Day>USA Florida 80-hour/8-Day</option><option value=HosRuleSetFloridaShortHaul7Day>USA Florida Short-haul 70-hour/7-Day</option><option value=HosRuleSetFloridaShortHaul8Day>USA Florida Short-haul 80-hour/8-Day</option><option value=HosRuleSetMarylandShortHaul7Day>Maryland Short Haul 70-hour/7-day</option><option value=HosRuleSetMarylandShortHaul8Day>Maryland Short Haul 80-hour/8-day</option><option value=HosRuleSetNebraska7day>Nebraska 70-hour/7-day</option><option value=HosRuleSetNebraska8day>Nebraska 80-hour/8-day</option><option value=HosRuleSetNone>No Ruleset (7-day cycle)</option><option value=HosRuleSetNone8Day>No Ruleset (8-day cycle)</option><option value=HosRuleSetNorthDakota7Day>North Dakota 70-hour/7-day</option><option value=HosRuleSetNorthDakotaShortHaul7Day>North Dakota Short Haul 70-hour/7-day</option><option value=HosRuleSetOilTransport7Day>USA Property 60-hour/7-day 24-hour restart</option><option value=HosRuleSetOilTransport7DayBig>USA Property 60-hour/7-day 24-hour restart (16-hour exemption)</option><option value=HosRuleSetOilTransport8Day>USA Property 70-hour/8-day 24-hour restart</option><option value=HosRuleSetOilTransport8DayBig>USA Property 70-hour/8-day 24-hour restart (16-hour exemption)</option><option value=HosRuleSetOilTransportCalifornia8day>California Oil Transport Property Intrastate with rest requirement</option><option value=HosRuleSetOilTransportNoRestRequirement7Day>USA Oil Transport 60-hour/7-day without rest requirement</option><option value=HosRuleSetOilTransportNoRestRequirement7DayBig>USA Oil Transport 60-hour/7-day (16-hour exemption) without rest requirement</option><option value=HosRuleSetOilTransportNoRestRequirement8Day>USA Oil Transport 70-hour/8-day without rest requirement</option><option value=HosRuleSetOilTransportNoRestRequirement8DayBig>USA Oil Transport 70-hour/8-day (16-hour exemption) without rest requirement</option><option value=HosRuleSetOilTransportShortHaul>USA Property Short-haul 60-hour/7-day 12hr Workday 24-hour restart</option><option value=HosRuleSetOilTransportShortHaul8Day>USA Property Short-haul 70-hour/8-day 12hr Workday 24-hour restart</option><option value=HosRuleSetOilTransportTexas>USA Texas Oil Transport 70-hour/7-day</option><option value=HosRuleSetOilWell7Day>USA Oil Well 60-hour/7-day</option><option value=HosRuleSetOilWell7DayBig>USA Oil Well 60-hour/7-day (16-hour exemption)</option><option value=HosRuleSetOilWell8Day>USA Oil Well 70-hour/8-day</option><option value=HosRuleSetOilWell8DayBig>USA Oil Well 70-hour/8-day (16-hour exemption)</option><option value=HosRuleSetOilWellCalifornia8day>California Oil Well Property Intrastate with rest requirement</option><option value=HosRuleSetOilWellNoRestRequirement7Day>USA Oil Well 60-hour/7-day without rest requirement</option><option value=HosRuleSetOilWellNoRestRequirement7DayBig>USA Oil Well 60-hour/7-day (16-hour exemption) without rest requirement</option><option value=HosRuleSetOilWellNoRestRequirement8Day>USA Oil Well 70-hour/8-day without rest requirement</option><option value=HosRuleSetOilWellNoRestRequirement8DayBig>USA Oil Well 70-hour/8-day (16-hour exemption) without rest requirement</option><option value=HosRuleSetOilWellTexas>USA Texas Oil Well 70-hour/7-day</option><option value=HosRuleSetOregon7day>Oregon 70-hour/7-day</option><option value=HosRuleSetOregon8day>Oregon 80-hour/8-day</option><option value=HosRuleSetSouthCarolina7Day>South Carolina 70-hour/7-day</option><option value=HosRuleSetSouthCarolina8Day>South Carolina 80-hour/8-day</option></select></div><p></p><p></p><div class=checkmateField><label class=label>Yard Move Allowed:</label><div class="flexible set-2x buttonSet horizontalButtonSet adjustableButtonSet" id=options_yardModeSelect title="Toggling this setting to ON allows the driver to apply the yard move exemption."><input type=radio name=yardMoveRadioButton value=On id=idYardMoveOn><label class="geotabButton switcherItem_Metric" for=idYardMoveOn>On</label><input type=radio name=yardMoveRadioButton value=Off id=idYardMoveOff checked=checked><label class="geotabButton switcherItem_US" for=idYardMoveOff>Off</label></div></div><p></p><p></p><div class=checkmateField><label class=label>Personal Conveyance Allowed:</label><div class="flexible set-2x buttonSet horizontalButtonSet adjustableButtonSet" id=options_personalConveyanceSelect title="Toggling this setting to ON allows the driver to apply the personal conveyance exemption."><input type=radio name=personalConveyanceRadioButton value=On id=idPersonalConveyanceOn><label class="geotabButton switcherItem_Metric" for=idPersonalConveyanceOn>On</label><input type=radio name=personalConveyanceRadioButton value=Off id=idPersonalConveyanceOff checked=checked><label class="geotabButton switcherItem_US" for=idPersonalConveyanceOff>Off</label></div></div><p></p></ul><p></p><h3>Step 1: Click Add user (can view the inputted information in the input container below)</h3><button class=primary-btn id=addUser>Add user</button><p></p><p></p><h3>Step 2: Click Import users</h3><button class=primary-btn id=importUsers disabled=disabled>Import users</button>&nbsp;&nbsp; <button type=button class=secondary-btn id=pauseBtn style=display:none;>Pause</button>&nbsp;&nbsp; <button type=button class=primary-btn id=resumeBtn style=display:none;>Resume</button>&nbsp;&nbsp; <button type=button class=secondary-btn id=exportResultsBtn disabled=disabled onclick=exportImportResults();>Export Results CSV</button>&nbsp;&nbsp; <button type=button class=secondary-btn id=clear onclick=ClearFields();>Clear</button><p></p><div class=progress-container id=progressContainer><div class=progress-bar-container><div class=progress-bar-fill id=progressBarFill>0%</div></div><div class=progress-stats><div class=stat-card><div class=stat-value id=totalUsers>0</div><div class=stat-label>Total Users</div></div><div class=stat-card><div class=stat-value id=successCount>0</div><div class=stat-label>Success</div></div><div class=stat-card><div class=stat-value id=failureCount>0</div><div class=stat-label>Failed</div></div><div class=stat-card><div class=stat-value id=remainingCount>0</div><div class=stat-label>Remaining</div></div></div></div><div class=results-section id=resultsSection><h3>Import Results</h3><table class=results-table><thead><tr><th>Status</th><th>Email</th><th>Name</th><th>Message</th></tr></thead><tbody id=resultsBody></tbody></table></div><p><textarea id=content cols=80 rows=8></textarea></p></form></div></div><div id=template-content><h2>Template</h2><p>This SDK example assists with importing users to your database using comma separated values (CSV).</p><p>Use the form to add new users with optional NFC or GO driver keys. You can also use the text box to paste in users from another source.<table><thead><tr><th>Value</th><th>Example</th><th>Notes</th><th>Required</th></tr></thead><tbody><tr><td>Email</td><td>john.smith@geotab.com</td><td>Can be email or user name. Spaces are not allowed.</td><td><b>Yes</b></td></tr><tr><td>First name</td><td>John</td><td>Spaces are not allowed.</td><td><b>Yes</b></td></tr><tr><td>Last name</td><td>Smith</td><td></td><td><b>Yes</b></td></tr><tr><td>Password</td><td></td><td>Minimum of 6 characters.</td><td><b>Yes</b></td></tr><tr><td>Groups</td><td>Drivers|West|Garmin</td><td>Names of groups separated by the | character.</td><td><b>Yes</b></td></tr><tr><td>Reporting Groups</td><td>Drivers|West|Garmin</td><td>Names of reporting groups separated by the | character.</td><td>No</td></tr><tr><td>Security clearance ID</td><td>b28A7</td><td>Found in the URL when viewing a security clearance in MyGeotab.<br><br>Example:<br>my.geotab.com/DATABASE/#clearance,id:<strong>b28A7</strong></td><td><b>Yes</b></td></tr><tr><td>NFC key number</td><td>T1234S</td><td>Found on the NFC key fob.</td><td>No</td></tr><tr><td>Custom NFC key number</td><td>12345678</td><td>Found on the Custom NFC key fob.</td><td>No</td></tr><tr><td>Country Code</td><td>CA</td><td>The user two symbols country ISO code (https://www.iso.org/iso-3166-country-codes.html)</td><td>No</td></tr><tr><td>Phone number</td><td>+1 5555555555</td><td>The user's phone number with space separated country phone code.</td><td>No</td></tr><tr><td>Phone number extension</td><td>1234</td><td>The user's phone number extension.</td><td>No</td></tr><tr><td>Designation</td><td>""</td><td>The user's designation</td><td>No</td></tr><tr><td>Employee number</td><td>63-221-44</td><td>The user's employee number.</td><td>No</td></tr><tr><td>Fuel economy measurement</td><td>LitersPer100Km</td><td>Choose how to display fuel economy. There are four different measurements: liters per 100 kilometers, kilometers per liter, miles per US gallon, or miles per imperial gallon. You may need to refresh your browser for the change to take effect.</td><td><b>Yes</b></td></tr><tr><td>Distance measurement system</td><td>Metric (true)</td><td>Choose how to display speeds and distances. This can be Metric or US/Imperial. You may need to refresh your browser to see the change take effect.</td><td><b>Yes</b></td></tr><tr><td>Feature preview</td><td>On or Off (true or false)</td><td>Toggle feature preview.</td><td><b>Yes</b></td></tr><tr><td>Time zone</td><td>America/New_York</td><td>The time zone offset from UTC for your location. All data will be displayed in this time zone.</td><td><b>Yes</b></td></tr><tr><td>Authority name</td><td>National Express</td><td>The motor carrier that the driver works for.</td><td>No</td></tr><tr><td>Authority address</td><td>5000 Explorer Drive</td><td>The motor carrier's main office address.</td><td>No</td></tr><tr><td>Carrier number</td><td>8Z88</td><td>In the United States, this is the motor carrier's USDOT number. In Canada, this is the Canadian Carrier code.</td><td>No</td></tr><tr><td>Home terminal</td><td>Stark Tower</td><td>The motor carrier's place of business where the driver ordinarily reports for work. This can include a temporary work site designated by the motor carrier.</td><td>No</td></tr><tr><td>Home terminal address</td><td>200 Park Avenue</td><td>The motor carrier's address where the driver ordinarily reports for work.</td><td>No</td></tr><tr><td>Driver license number</td><td>YEET</td><td>Driver's license number and License state/province must be set at the same time.</td><td>No</td></tr><tr><td>License state/province</td><td>Ontario (ON)</td><td>Selecting North America will show a dropdown menu; selecting Other will display a text box.</td><td>No</td></tr><tr><td>Ruleset</td><td>California Property Intrastate (HosRuleSetCaliforniaProperty)</td><td>This is the ruleset the user will follow when using hours of service.</td><td>No</td></tr><tr><td>Yard move allowed</td><td>On or Off (true or false)</td><td>Toggling this setting to ON allows the driver to apply the yard move exemption.</td><td><b>Yes</b></td></tr><tr><td>Personal conveyance allowed</td><td>On of Off (true or false)</td><td>Toggling this setting to ON allows the driver to apply the personal conveyance exemption.</td><td><b>Yes</b></td></tr><tr><td>Delay verification email</td><td>On or Off (true or false)</td><td>Toggling this setting to ON will delay sending the verification email to the user.</td><td><b>Yes</b></td></tr></tbody></table></p><p>To make things easier, we've provided you with an <a href=templates/import-users-template.xlsx target=_blank>excel template</a>. Please follow the input requirements outlined in the Help menu.<br><br>Keep in mind that Time Zone is a required input and if a license plate is entered, it must be unique to the database. License state is required only if a license plate is provided. You may enter a state other than those provided.<br><br>NFC and Custom NFC keys must be unique to the database; no duplicates can exist.<br><br>If you want to import any reporting groups - the user groups cannot include the "CompanyGroupId", otherwise all reporting groups wiil be ignored.<br><br>The Delay Verification Email setting (On or Off) is required and controls whether the verification email is sent immediately or delayed when creating new users.<br></p><div class=code><pre>Email1,FirstName,LastName,Password,GroupName1|GroupName2|...|GroupNameN,ReportingGroupName1|ReportingGroupName2|...|ReportingGroupNameN,SecurityClearanceId,NfcKey,CustomNfcKey,EmployeeNumber,FuelEconomyMeasurement,DistanceMeasurementSystem,FeaturePreview,TimeZone,AuthorityName,AuthorityAddress,CarrierNumber,HomeTerminal,HomeTerminalAddress,DriverLicenseNumber,LicenseState,Ruleset,YardMoveAllowed,PersonalConveyanceAllowed,DelayVerificationEmail<br>Email2,FirstName,LastName,Password,GroupName1|GroupName2|...|GroupNameN,ReportingGroupName1|ReportingGroupName2|...|ReportingGroupNameN,SecurityClearanceId,NfcKey,,EmployeeNumber,,,,TimeZone,AuthorityName,AuthorityAddress,CarrierNumber,HomeTerminal,HomeTerminalAddress,DriverLicenseNumber,LicenseState,Ruleset,YardMoveAllowed,PersonalConveyanceAllowed,DelayVerificationEmail<br>Email3,FirstName,LastName,Password,GroupName1|GroupName2|...|GroupNameN,ReportingGroupName1|ReportingGroupName2|...|ReportingGroupNameN,SecurityClearanceId,NfcKey,,,,,,,,,,,,,,Ruleset,,,</pre></div><p></p></div><script src=js/api.js></script><script src=js/login.js></script><script src=https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/chosen/1.1.0/chosen.jquery.min.js></script><script type=text/javascript>var groupCache = {};
            var securityClearanceCache = {};
			var selectedGroups = [];
            var selectedReportGroups = [];
			var passwordResetCheckbox = document.getElementById("import-password-reset");
			var hosRulesetArray = [];
            // Enhanced import state for progressive removal
            var enhancedImportState = {
                isRunning: false,
                isPaused: false,
                users: [],
                currentIndex: 0,
                successCount: 0,
                failureCount: 0,
                failedCSVLines: [],
                processNextUserFn: null,
                importResults: []  // Store all import results for export
            };

			var moreCalls = [];

			function toggleDocs(event) {

				if (event.target && event.target.className == 'clickable-heading secondary-btn') {

					var next = event.target.nextElementSibling;


					if (next.style.display == "none") {
						next.style.display = "block";

					} else {
						next.style.display = "none";
					}
				}
			}

			function yesnoCheck() {
    			if (document.getElementById('idLicenseStateNA').checked) {
					document.getElementById('ifYes').style.display = 'block';
					document.getElementById('ifNo').style.display = 'none';
    			}
				else {
					document.getElementById('ifYes').style.display = 'none';
					document.getElementById('ifNo').style.display = 'block';
				}
			}

			document.addEventListener('click', toggleDocs, true);

            document.addEventListener("DOMContentLoaded", function() {	
				document.getElementById("content").addEventListener("keyup", function(event) {
					event.preventDefault();
					
					document.getElementById("importUsers").disabled = (event.target.value === "");
				});
				
				$("#import-groups").on("change", function(event, parameters) {
					if (parameters.selected) {
						selectedGroups.push(parameters.selected);
					} else {
						var index = selectedGroups.indexOf(parameters.deselected);
						if (index > -1) {
							selectedGroups.splice(index, 1);
						}
					}
				});

                $("#import-reporting-groups").on("change", function(event, parameters) {
					if (parameters.selected) {
						selectedReportGroups.push(parameters.selected);
					} else {
						var index = selectedReportGroups.indexOf(parameters.deselected);
						if (index > -1) {
							selectedReportGroups.splice(index, 1);
						}
					}
				});

				
				document.getElementById("addUser").addEventListener("click", function(event) {
					event.preventDefault();
					
					var user = parseUserFromFields();
					
					if (user.userName === "") {
						alert("Email or user name is required");
						return;
					}
					if (user.userName.indexOf(" ") >= 0) {
						alert("Email or user name cannot contain a space");
						return;
					}
					if (user.firstName === "") {
						alert("First name is required");
						return;
					}
					if (user.lastName === "") {
						alert("Last name is required");
						return;
					}
					if (!$(passwordResetCheckbox).is(":checked") && user.password === "") {
						alert("Password is required");
						return;
					}
					if (user.groups.length <= 0) {
						alert("User must belong to at least one group");
						return;
					}
					if (user.securityClearance === "") {
						alert("Security clearance is required");
						return;
					}
					if (isNaN(user.customNfcKey) || user.customNfcKey < 0 || user.customNfcKey > 72057594037927940) {
						alert("Custom NFC Key Serial Number must be between 0 and 72057594037927940");
						return;
					}
					if (user.phoneNumber !== "" && ( !(user.phoneNumber.indexOf(" ") >= 0) || user.phoneNumber.charAt(0) !== "+" )) {
						alert("Invalid PhoneNumber. Phone number should start with '+' and the country phone code, followed by the phone number without formatting separated by a space. Example: +1 5555555555");
						return;
					}
					if ( user.phoneNumberExtension !== "" &&  (isNaN(user.phoneNumberExtension))) {
						alert("Phone number extensions cannot exceed five characters and must contain only digits.")
						return;
					}
					
					var newContent = document.getElementById("content").value;
					
					if (newContent !== "") {
						newContent += "\n";
					}
					newContent += user.userName + ",";
					newContent += user.firstName + ",";
					newContent += user.lastName + ",";
					newContent += user.password + ",";
					for (var i = 0; i < user.groups.length; i++) {
						if (i < user.groups.length - 1) {
							newContent += user.groups[i] + "|";
						} else {
							newContent += user.groups[i] + ",";
						}
					}
                    // Reporting groups, can be emtpy
                    if (user.reportGroups.length !== 0){
                        for (var i = 0; i < user.reportGroups.length; i++) {
                            if (i < user.reportGroups.length - 1) {
                                newContent += user.reportGroups[i] + "|";
                            } else {
                                newContent += user.reportGroups[i] + ",";
                            }
                        }
                    } else {
                        newContent += ',';
                    }

					newContent += user.securityClearance + ",";
					newContent += user.nfcKey + ",";
					newContent += user.customNfcKey + ",";
					newContent += user.countryCode + ",";
					newContent += user.phoneNumber + ",";
					newContent += user.phoneNumberExtension + ",";
					newContent += user.designation + ",";
					newContent += user.employeeNo + ",";
					newContent += user.fuelEconomyUnit + ",";
					newContent += user.isMetric + ",";
					newContent += user.isLabsEnabled + ",";
                    newContent += user.timeZoneId + ",";
                    newContent += user.authorityName + ",";
                    newContent += user.authorityAddress + ",";
                    newContent += user.carrierNumber + ",";
                    newContent += user.companyName + ",";
                    newContent += user.companyAddress + ",";
                    newContent += user.licenseNumber + ",";
                    newContent += user.licenseProvince + ",";
                    newContent += user.hosRuleSet + ",";
					newContent += user.isYardMoveEnabled + ",";
					newContent += user.isPersonalConveyanceEnabled + ",";
					newContent += user.delayWelcomeEmail;

					document.getElementById("content").value = newContent;
					document.getElementById("importUsers").disabled = false;
				});

                
            // Helper: Update user count badge
            function updateUserCount() {
                var content = document.getElementById("content").value.trim();
                if (!content) {
                    document.getElementById("userCountBadge").textContent = '0 users';
                    return;
                }
                var lines = content.split("\n").filter(function(line) { return line.trim() !== ""; });
                document.getElementById("userCountBadge").textContent = lines.length + ' user' + (lines.length !== 1 ? 's' : '');
            }

            // Helper: Update progress UI
            function updateProgressUI() {
                var total = enhancedImportState.users.length;
                var processed = enhancedImportState.currentIndex;
                var remaining = total - processed;
                var percentage = total > 0 ? Math.round((processed / total) * 100) : 0;

                document.getElementById("progressBarFill").style.width = percentage + '%';
                document.getElementById("progressBarFill").textContent = percentage + '%';
                document.getElementById("totalUsers").textContent = total;
                document.getElementById("successCount").textContent = enhancedImportState.successCount;
                document.getElementById("failureCount").textContent = enhancedImportState.failureCount;
                document.getElementById("remainingCount").textContent = remaining;
            }

            // Helper: Add result row to table (NO EMOJIS)
            function addResultRow(success, email, name, message) {
                var tbody = document.getElementById("resultsBody");
                var row = tbody.insertRow(0);
                row.className = success ? 'success-row' : 'error-row';
                row.insertCell(0).textContent = success ? '[OK]' : '[FAIL]';
                row.insertCell(1).textContent = email;
                row.insertCell(2).textContent = name;
                row.insertCell(3).textContent = message;

                // Store result for export
                enhancedImportState.importResults.push({
                    success: success,
                    email: email,
                    name: name,
                    message: message
                });
            }

            // Helper: Remove CSV line from textarea
            function removeCSVLineFromTextarea(index) {
                try {
                    var currentText = document.getElementById("content").value;
                    var lines = currentText.split("\n").filter(function(line) { return line.trim() !== ""; });
                    lines.splice(index, 1);
                    document.getElementById("content").value = lines.join("\n");
                    updateUserCount();
                } catch (error) {
                    console.error('Error removing CSV line:', error);
                }
            }

            // Helper: Export failed users to CSV
            function exportFailedUsers() {
                if (enhancedImportState.failedCSVLines.length === 0) {
                    alert('No failed users to export');
                    return;
                }
                var csvContent = enhancedImportState.failedCSVLines.join("\n");
                var blob = new Blob([csvContent], { type: 'text/csv' });
                var url = URL.createObjectURL(blob);
                var a = document.createElement('a');
                a.href = url;
                a.download = 'failed-users-' + new Date().toISOString().split('T')[0] + '.csv';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                alert('Exported ' + enhancedImportState.failedCSVLines.length + ' failed users to CSV file');
            }

            // Helper: Export import results to CSV (Global scope)
            window.exportImportResults = function() {
                if (enhancedImportState.importResults.length === 0) {
                    alert('No import results to export. Please run an import first.');
                    return;
                }

                // Create CSV header
                var csvContent = 'Status,Email,Name,Message\n';

                // Add each result row (no quotes)
                enhancedImportState.importResults.forEach(function(result) {
                    var status = result.success ? 'SUCCESS' : 'FAILED';
                    var email = result.email || '';
                    var name = result.name || '';
                    var message = result.message || '';

                    csvContent += status + ',' + email + ',' + name + ',' + message + '\n';
                });

                // Create and download the file
                var blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                var url = URL.createObjectURL(blob);
                var a = document.createElement('a');
                a.href = url;
                a.download = 'import-results-' + new Date().toISOString().split('T')[0] + '.csv';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                alert('Exported ' + enhancedImportState.importResults.length + ' import results to CSV file');
            };

            // Helper: Pause import
            function pauseImport() {
                enhancedImportState.isPaused = true;
                document.getElementById("pauseBtn").style.display = 'none';
                document.getElementById("resumeBtn").style.display = 'inline-block';
                alert('Import paused. Click Resume to continue.');
            }

            // Helper: Resume import
            function resumeImport() {
                enhancedImportState.isPaused = false;
                document.getElementById("pauseBtn").style.display = 'inline-block';
                document.getElementById("resumeBtn").style.display = 'none';
                if (enhancedImportState.processNextUserFn) {
                    enhancedImportState.processNextUserFn();
                }
            }

            // Update count on textarea change
            document.addEventListener("DOMContentLoaded", function() {
                document.getElementById("content").addEventListener("input", updateUserCount);
                document.getElementById("pauseBtn").addEventListener("click", pauseImport);
                document.getElementById("resumeBtn").addEventListener("click", resumeImport);
            });

document.getElementById("importUsers").addEventListener("click", function(event) {
                    event.preventDefault();

                    // Check authentication before starting import
                    if (typeof api === 'undefined' || !api || typeof api.call !== 'function') {
                        alert("Please sign in to MyGeotab before importing users.\n\nClick the 'Sign in' button at the top right to authenticate.");
                        return;
                    }

                    hosRulesetArray = [];

                    var content = document.getElementById("content").value;

                    if (content === "") {
                        alert("At least one user is required");
                    } else {
                        var userRows = content.split("\n");
						
						var users = [];
						
						for (var i = 0; i < userRows.length; i++) {
							if (userRows[i].trim() !== "") {
								users.push(userRows[i].trim());
							}
						}
						
                        var calls = [];
                        var userListAndRuleset = [];
						
                        for (i = 0; i < users.length; i++) {
                            var split = users[i].split(",");

                            if (split.length !== 29) {
                                alert("Missing necessary information from user: " + users[i]);
                                continue;
                            }

                            var userName = split[0];
                            var firstName = split[1];
                            var lastName = split[2];
                            var password = split[3];
                            var groups = parseGroups(split[4]);
                            var reportGroups = parseReportingGroups(split[5]);
                            var securityGroups = parseSecurityClearanceName(split[6]);
							var keys = parseKeys(split[7], split[8]);
							var countryCode = split[9].toLowerCase();
							var phoneNumber = split[10]; 
							var phoneNumberExtension = split[11];
							var designation = split[12];
							var employeeNo = split[13];
							var fuelEconomyUnit = split[14];
							var isMetric = split[15];
							var isLabsEnabled = split[16];
                            var timeZoneId = split[17];
                            var authorityName = split[18];
                            var authorityAddress = split[19];
                            var carrierNumber = split[20];
                            var companyName = split[21];
                            var companyAddress = split[22];
                            var licenseNumber = split[23];
                            var licenseProvince = split[24];    
                            var hosRuleSet = split[25];
							var isYardMoveEnabled = split[26];
							var isPersonalConveyanceEnabled = split[27];
							var delayWelcomeEmail = split[28];

							// when pasting in ',' seperated string make sure values aren't empty
							if (isYardMoveEnabled === '') {
								var isYardMoveEnabled = false;
							} 
							if (isPersonalConveyanceEnabled === '') {
								var isPersonalConveyanceEnabled = false;
							}
							delayWelcomeEmail = (delayWelcomeEmail === 'true');
							
							var newUser = {
								name: userName,
								firstName: firstName,
								lastName: lastName,
								password: password,
								companyGroups: groups,
                                reportGroups: reportGroups,
								securityGroups: securityGroups,
								userAuthenticationType: "BasicAuthentication",
								activeFrom: new Date().toISOString(),
								activeTo: "2050-01-01T00:00:00.000Z",
								countryCode: countryCode,
								phoneNumber: phoneNumber,
								phoneNumberExtension: phoneNumberExtension,
								designation: designation,
								employeeNo: employeeNo,
								fuelEconomyUnit: fuelEconomyUnit,
								isMetric: isMetric,
								isLabsEnabled: isLabsEnabled,
                                timeZoneId: timeZoneId,
                                authorityName: authorityName,
                                authorityAddress: authorityAddress,
                                carrierNumber: carrierNumber,
                                companyName: companyName,
                                companyAddress: companyAddress,
                                licenseNumber: licenseNumber,
                                licenseProvince: licenseProvince,
								isYardMoveEnabled: isYardMoveEnabled,
								isPersonalConveyanceEnabled: isPersonalConveyanceEnabled,
								sendWelcomeEmail: !delayWelcomeEmail
							};

							if (keys.length > 0){
								newUser.driverGroups =  groups;
								newUser.viewDriversOwnDataOnly =  false;
								newUser.keys = keys;
								newUser.isDriver = true;
                            }
                            if (licenseNumber.length > 0){
                                newUser.driverGroups =  groups;
								newUser.viewDriversOwnDataOnly =  false;
                                newUser.isDriver = true;
                            }
							if ($(passwordResetCheckbox).is(":checked"))
							{
								newUser.changePassword = true;
                            }
                            
							hosRulesetArray.push(hosRuleSet);

							calls.push([
								"Add", {
									typeName: "User",
									entity: newUser
								}
							]);                            
                        }
						
						// Initialize enhanced import state
						enhancedImportState.isRunning = true;
						enhancedImportState.isPaused = false;
						enhancedImportState.users = users;
						enhancedImportState.currentIndex = 0;
						enhancedImportState.successCount = 0;
						enhancedImportState.failureCount = 0;
						enhancedImportState.failedCSVLines = [];
						enhancedImportState.importResults = [];  // Reset results for new import

						// Show progress container and results section
						document.getElementById("progressContainer").style.display = 'block';
						document.getElementById("resultsSection").style.display = 'block';
						document.getElementById("resultsBody").innerHTML = '';
						document.getElementById("pauseBtn").style.display = 'inline-block';
						document.getElementById("resumeBtn").style.display = 'none';
						document.getElementById("exportResultsBtn").disabled = true;

						// Disable import button during processing
						document.getElementById("importUsers").disabled = true;

						// Start sequential processing
						processUsersSequentially(calls, users, hosRulesetArray);

						// Sequential user processing function
						function processUsersSequentially(calls, userRows, hosRulesets) {
							var currentCallIndex = 0;

							function processNextUser() {
								// Store reference for resume functionality
								enhancedImportState.processNextUserFn = processNextUser;

								// Check if paused
								if (enhancedImportState.isPaused) {
									return; // Wait for resume
								}

								// Check if finished
								if (currentCallIndex >= calls.length) {
									// All users processed
									enhancedImportState.isRunning = false;
									document.getElementById("importUsers").disabled = false;
									document.getElementById("pauseBtn").style.display = 'none';
									document.getElementById("resumeBtn").style.display = 'none';

									// Enable export results button
									document.getElementById("exportResultsBtn").disabled = false;

									// Show completion alert
									alert("Import complete!\nSuccess: " + enhancedImportState.successCount + "\nFailed: " + enhancedImportState.failureCount + "\nTotal: " + calls.length);
									return;
								}

								// Process current user
								var call = calls[currentCallIndex];
								var userEntity = call[1].entity;
								var originalCSVLine = userRows[currentCallIndex];
								var userEmail = userEntity.name;
								var userName = userEntity.firstName + " " + userEntity.lastName;
								var hosRuleset = hosRulesets[currentCallIndex];

								// Make API call for single user
								api.call("Add", {
									typeName: "User",
									entity: userEntity
								}, function(userId) {
									// SUCCESS - Add HOS ruleset if specified, then handle success
									if (hosRuleset !== "" && hosRuleset !== undefined) {
										var hosEntity = {
											dateTime: new Date().toISOString(),
											hosRuleSet: {"id": hosRuleset},
											user: {"id": userId}
										};
										api.call("Add", {
											typeName: "UserHosRuleSet",
											entity: hosEntity
										}, function(result) {
											// HOS ruleset added successfully
											handleSuccess(userId, userEmail, userName, originalCSVLine, currentCallIndex);
										}, function(hosError) {
											// User added but HOS ruleset failed
											console.error("HOS ruleset error:", hosError);
											handleSuccess(userId, userEmail, userName, originalCSVLine, currentCallIndex, "User added but HOS ruleset failed: " + hosError);
										});
									} else {
										// No HOS ruleset, just handle success
										handleSuccess(userId, userEmail, userName, originalCSVLine, currentCallIndex);
									}
								}, function(error) {
									// FAILURE
									handleFailure(error, userEmail, userName, originalCSVLine, currentCallIndex);
								});

								currentCallIndex++;
								enhancedImportState.currentIndex = currentCallIndex;
								updateProgressUI();
							}

							function handleSuccess(userId, email, name, csvLine, index, warningMessage) {
								enhancedImportState.successCount++;
								var message = warningMessage || "User imported successfully";
								addResultRow(true, email, name, message);

								// PROGRESSIVE REMOVAL - Always remove first line (index 0)
								// because we process users sequentially from top to bottom
								removeCSVLineFromTextarea(0);

								// Update progress display
								updateProgressUI();

								// Continue to next user after short delay
								setTimeout(processNextUser, 100);
							}

							function handleFailure(error, email, name, csvLine, index) {
								enhancedImportState.failureCount++;
								enhancedImportState.failedCSVLines.push(csvLine);

								// Parse error message
								var errorMessage = "Unknown error";
								var errorStr = error.toString();

								if (errorStr.indexOf("checksum") > -1) {
									errorMessage = "NFC driver keys entered incorrectly";
								} else if (errorStr.indexOf("Index was outside") > -1) {
									errorMessage = "Custom NFC driver keys entered incorrectly";
								} else if (errorStr.indexOf("DuplicateUserException") > -1) {
									errorMessage = "User name already exists";
								} else if (errorStr.indexOf("DuplicateException") > -1) {
									errorMessage = "Driver key already exists";
								} else if (errorStr.indexOf("The password cannot contain the username") > -1) {
									errorMessage = "Password cannot contain username/first name/last name";
								} else if (errorStr.indexOf("Password policy requires") > -1) {
									errorMessage = "Password must be at least 8 characters";
								} else if (errorStr.indexOf("Common passwords") > -1) {
									errorMessage = "Common passwords not allowed";
								} else if (errorStr.indexOf("CompanyGroups cannot be null or empty") > -1) {
									errorMessage = "Invalid company group name";
								} else if (errorStr.indexOf("SecurityGroups") > -1) {
									errorMessage = "Invalid security group name";
								} else {
									errorMessage = errorStr.substring(0, 100); // Truncate long errors
								}

								addResultRow(false, email, name, errorMessage);

								// DO NOT remove failed line from textarea - keep it for user to see/fix
								// Update progress display
								updateProgressUI();

								// Continue to next user after short delay
								setTimeout(processNextUser, 100);
							}

							// Start processing first user
							updateProgressUI();
							processNextUser();
						}

						var pushRulesets = function (userIds) {
							for (i = 0; i < userIds.length; i++) {

								var anotherUser = {
									dateTime: new Date().toISOString(),
									hosRuleSet: {"id": hosRulesetArray[i]},
									user: {"id": userIds[i]}
								};

								//if no ruleset is selected, do not push one to user
								if (hosRulesetArray[i] !== "") {

								moreCalls.push([
									"Add", {
										typeName: "UserHosRuleSet",
										entity: anotherUser
									}
								]);
								}
							}
						}
                    }
                });		
				groupCache = refreshGroupCache(null);
				//timeZoneCache = refreshTimeZoneCache(null);
				//securityClearanceCache = refreshSecurityClearanceCache(null);
            });
            function refreshGroupCache(callback) {
				var select = document.getElementById("import-groups");
                var selectR = document.getElementById("import-reporting-groups");
			
                api.call("Get", {
                    typeName: "Group"
                }, function(result) {
                    if (result !== undefined && result != null && result.length > 0) {
                        groupCache = {};
                        for (var i = 0; i < result.length; i++) {
                            if (result[i].name === undefined) {
								result[i].name = result[i].id;
                            }
                        }
						result.sort(function(a, b) {
							if (a.name.toLowerCase() < b.name.toLowerCase()) {
								return -1;
							}
							if (a.name.toLowerCase() > b.name.toLowerCase()) {
								return 1;
							}
							return 0;
						});
						for (i = 0; i < result.length; i++) {
							groupCache[result[i].name] = result[i];
							var option = new Option();
							option.text = result[i].name;
							option.value = result[i].id;
							select.add(option);
                            var optionR = new Option();
							optionR.text = result[i].name;
							optionR.value = result[i].id;
                            selectR.add(optionR);
						}
						timeZoneCache = refreshTimeZoneCache(null);
						securityClearanceCache = refreshSecurityClearanceCache(null);
                    }
					$("#import-groups").chosen({
						search_contains: true
					});
                    $("#import-reporting-groups").chosen({
						search_contains: true
					});
                    if (callback) {
                        callback();
                    }
                }, function(error) {
                    console.log(error);
                });
            }

			function refreshTimeZoneCache(callback) {
				var select = document.getElementById("options_userTimeZoneOffset");
			
                api.call("GetTimeZones", {}, function(result) {
                    if (result !== undefined && result != null && result.length > 0) {
                        timeZoneCache = {};

						result.sort(function(a, b) {
							if (a.id.toLowerCase() < b.id.toLowerCase()) {
								return -1;
							}
							if (a.id.toLowerCase() > b.id.toLowerCase()) {
								return 1;
							}
							return 0;
						});
						for (i = 0; i < result.length; i++) {
							timeZoneCache[result[i].id] = result[i];
							var option = new Option();
							option.text = result[i].id;
							option.value = result[i].id;
							select.add(option);
						}
                    }
                    if (callback) {
                        callback();
                    }
                }, function(error) {
                    console.log(error);
                });
            }

            function refreshSecurityClearanceCache(callback) {
				var select = document.getElementById("import-securityClearance");
			
                api.call("Get", {
                    typeName: "Group",
                    search: {
                        id: "GroupSecurityId"
                    }
                }, function(result) {
                    if (result !== undefined && result != null && result.length > 0) {
                        securityClearanceCache = {};
                        for (var i = 0; i < result.length; i++) {
                            if (result[i].name === undefined) {
								result[i].name = result[i].id;
                            }
                        }
						result.sort(function(a, b) {
							if (a.name.toLowerCase() < b.name.toLowerCase()) {
								return -1;
							}
							if (a.name.toLowerCase() > b.name.toLowerCase()) {
								return 1;
							}
							return 0;
						});
						for (i = 0; i < result.length; i++) {
							securityClearanceCache[result[i].id] = result[i];
							var option = new Option();
							option.text = result[i].name;
							option.value = result[i].id;
							select.add(option);
						}
                    }
                    if (callback) {
                        callback();
                    }
                }, function(error) {
                    console.log(error);
                });
            }

			function ClearFields() {
				// Clear textarea
				document.getElementById("content").value = "";

				// Hide progress container and results
				document.getElementById("progressContainer").style.display = 'none';
				document.getElementById("resultsSection").style.display = 'none';

				// Clear results table
				document.getElementById("resultsBody").innerHTML = '';

				// Reset import state
				enhancedImportState.importResults = [];
				enhancedImportState.successCount = 0;
				enhancedImportState.failureCount = 0;
				enhancedImportState.failedCSVLines = [];
				enhancedImportState.currentIndex = 0;

				// Disable export button
				document.getElementById("exportResultsBtn").disabled = true;

				// Update user count badge
				updateUserCount();
			}

			function parseUserFromFields() {
				var groups = [];
			
				for (var i = 0; i < selectedGroups.length; i++) {
					for (var key in groupCache) {
						if (groupCache[key].id == selectedGroups[i]) {
							groups.push(groupCache[key].name);
							break;
						}
					}
				}
				
                var reportGroups = [];
                for (var i = 0; i < selectedReportGroups.length; i++) {
					for (var key in groupCache) {
						if (groupCache[key].id == selectedReportGroups[i]) {
							reportGroups.push(groupCache[key].name);
							break;
						}
					}
				}
				
				var securityClearanceSelect = document.getElementById("import-securityClearance");
				var securityClearanceId = securityClearanceSelect[securityClearanceSelect.selectedIndex].value;

				if (document.getElementById("Lper100km").checked) {
					var fuelEconomySelect = document.getElementById("Lper100km").value;
				} else if (document.getElementById("kmperL").checked) {
					var fuelEconomySelect = document.getElementById("kmperL").value;
				} else if (document.getElementById("mpgUS").checked) {
					var fuelEconomySelect = document.getElementById("mpgUS").value;
				} else if (document.getElementById("mpgImp").checked) {
					var fuelEconomySelect = document.getElementById("mpgImp").value;
				} else {
					var fuelEconomySelect = "";
				}

				if (document.getElementById("metricUnit").checked) {
					var isMetric = true;
				}
				else {
					var isMetric = false;
				}
          
				if (document.getElementById("idFeaturePreviewOn").checked) {
					var isLabsEnabled = true;
				} else {
					var isLabsEnabled = false;
				}

				var timeZoneId = document.getElementById("options_userTimeZoneOffset").value;

                if (document.getElementById('idLicenseStateNA').checked) {
                    var plateState = document.getElementById("options_licenseProvince").value;
                } else if (document.getElementById('idLicenseStateOther').checked) {
                    var plateState = document.getElementById("options_LicenseStateOther").value;
                } else {var plateState = ""}

				var selectedHosRuleset = document.getElementById("options_hosRuleSet").value;

				if (document.getElementById("idYardMoveOn").checked) {
					var isYardMoveEnabled = true;
				} else {
					var isYardMoveEnabled = false;
				}

				if (document.getElementById("idPersonalConveyanceOn").checked) {
					var isPersonalConveyanceEnabled = true;
				} else {
					var isPersonalConveyanceEnabled = false;
				}

				if (document.getElementById("idDelayVerificationEmailOn").checked) {
					var delayWelcomeEmail = true;
				} else {
					var delayWelcomeEmail = false;
				}

                return {
					userName: document.getElementById("import-userName").value,
					firstName: document.getElementById("import-firstName").value,
					lastName: document.getElementById("import-lastName").value,
					password: document.getElementById("import-password").value,
					groups: groups,
                    reportGroups: reportGroups,
					securityClearance: securityClearanceId,
					nfcKey: document.getElementById("import-nfcKey").value,
					customNfcKey: document.getElementById("import-customNFC").value,
					countryCode: document.getElementById("import-countryCode").value,
					phoneNumber: document.getElementById("import-phoneNumber").value,
					phoneNumberExtension: document.getElementById("import-phoneNumberExtension").value,
					designation: document.getElementById("import-designation").value,
					employeeNo: document.getElementById("import-employeeNumber").value,
					fuelEconomyUnit: fuelEconomySelect,
					isMetric: isMetric,
					isLabsEnabled: isLabsEnabled,
                    timeZoneId: timeZoneId,
                    authorityName: document.getElementById("options_AuthorityName").value,
                    authorityAddress: document.getElementById("options_AuthorityAddress").value,
                    carrierNumber: document.getElementById("options_CarrierNumber").value,
                    companyName: document.getElementById("options_Name").value,
                    companyAddress: document.getElementById("options_Address").value,
                    licenseNumber: document.getElementById("options_LicenseNumber").value,
                    licenseProvince: plateState,
                    hosRuleSet: document.getElementById("options_hosRuleSet").value,
					isYardMoveEnabled: isYardMoveEnabled,
					isPersonalConveyanceEnabled: isPersonalConveyanceEnabled,
					delayWelcomeEmail: delayWelcomeEmail
				}
			}

            function parseGroups(text) {
                var result = [];
                var split = text.split("|");
                for (var i = 0; i < split.length; i++) {
                    if (groupCache.hasOwnProperty(split[i].trim())) {
                        result.push(groupCache[split[i].trim()]);
                    }
                }
                if (result.length <= 0) {
                    result.push(groupCache["GroupCompanyId"]);
                }
                return result;
            }

            
            function parseReportingGroups(text) {
                var result = [];
                var split = text.split("|");
                for (var i = 0; i < split.length; i++) {
                    if (groupCache.hasOwnProperty(split[i].trim())) {
                        result.push({"id": groupCache[split[i].trim()].id});
                    }
                }
                return result;
            }

            function parseSecurityClearanceName(text) {
                var result = [];
                var split = text.split("|");
                for (var i = 0; i < split.length; i++) {
                    if (securityClearanceCache.hasOwnProperty(split[i].trim())) {
                        result.push(securityClearanceCache[split[i].trim()]);
                    }
                }
                if (result.length <= 0) {
                    result.push(securityClearanceCache["GroupEverythingSecurityId"]);
                }
                return result;
            }

            function parseKeys(nfcKey, customNfcKey) {
                var keys = [];
                if (nfcKey !== "") {
                    keys.push({
                        serialNumber: nfcKey,
                        driverKeyType: "Nfc",
                        isImmobilizeOnly: true
                    });
                }
                if (customNfcKey > 0 && customNfcKey < 72057594037927940) {
                    keys.push({
                        serialNumber: customNfcKey,
                        driverKeyType: "CustomNfc",
                        isImmobilizeOnly: true
                    });
				} 
				else if (customNfcKey === "") {
					// do nothing	
				} 
				else alert("Custom NFC Key Serial Number must be between 0 and 72057594037927940.")
                return keys;
			}</script></body></html>